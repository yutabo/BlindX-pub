import gradio as gr
from pathlib import Path
from collections import Counter
import chardet
from proofreader import Proofreader  # â† é©å®œèª¿æ•´

def robust_read_text(path):
    raw = Path(path).read_bytes()
    detected = chardet.detect(raw)
    encoding = detected.get("encoding", "utf-8")
    try:
        return raw.decode(encoding)
    except Exception:
        return raw.decode("utf-8", errors="ignore")

def run_proofreader(files, output_dir_text, hotwords_text):
    if not files:
        return "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"

    hotwords = hotwords_text.strip().split()
    output_dir = Path(output_dir_text)
    output_dir.mkdir(parents=True, exist_ok=True)

    pf = Proofreader(hotwords=hotwords)

    # é‡è¤‡æ’é™¤ï¼†ãƒ‘ã‚¹ã¨ã—ã¦æ‰±ã†
    unique_paths = set(Path(f.name) for f in files)

    count = 0
    for path in unique_paths:
        text = robust_read_text(path)
        result = pf.process(text)
        out_path = output_dir / path.name
        out_path.write_text(result)
        count += 1

    return f"âœ… æ ¡æ­£å®Œäº†: {count} ä»¶å‡¦ç†ã—ã¾ã—ãŸï¼ˆå‡ºåŠ›å…ˆ: {output_dir}ï¼‰"

with gr.Blocks() as app:
    gr.Markdown("### ğŸ“ è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œãƒ»æ ¡æ­£ãƒ„ãƒ¼ãƒ« Web UI")

    files_input = gr.File(label="ğŸ“‚ æ ¡æ­£ã—ãŸã„ .txt ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¤‡æ•°é¸ã‚“ã§ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—", file_types=[".txt"], file_count="multiple")

    output_dir = gr.Textbox(label="ğŸ“ å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°è‡ªå‹•ä½œæˆï¼‰")
    hotwords = gr.Textbox(label="âœ¨ HOTWORDSï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰")

    run_button = gr.Button("ğŸš€ æ ¡æ­£ã‚¹ã‚¿ãƒ¼ãƒˆ")
    result = gr.Textbox(label="âœ… å‡¦ç†ãƒ­ã‚°")

    run_button.click(
        fn=run_proofreader,
        inputs=[files_input, output_dir, hotwords],
        outputs=result
    )

app.launch()
