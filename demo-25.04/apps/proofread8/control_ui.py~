import gradio as gr
from pathlib import Path
import chardet
from proofreader import Proofreader

def robust_decode(raw):
    detected = chardet.detect(raw)
    encoding = detected.get("encoding", "utf-8")
    try:
        return raw.decode(encoding)
    except Exception:
        return raw.decode("utf-8", errors="ignore")

def make_html_links(paths):
    links = []
    for p in paths:
        name = Path(p).name
        href = f"/file={p}"
        links.append(f'<a href="{href}" target="_blank">{name}</a>')
    return "<br>".join(links)

def run_proofreader(global_hotwords_text, local_hotwords_text, files):
    if not files:
        return "", "âŒ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"

    global_hotwords = global_hotwords_text.strip().split("\n")
    local_hotwords = local_hotwords_text.strip().split("\n")
    all_hotwords = list(set(global_hotwords + local_hotwords))

    pf = Proofreader(hotwords=all_hotwords)

    output_files = []
    output_dir = Path("output_html")
    output_dir.mkdir(exist_ok=True)

    for file in files:
        filename = Path(file.name).name
        raw = file.read()
        text = robust_decode(raw)
        result = pf.process(text)

        out_path = output_dir / filename
        out_path.write_text(result, encoding="utf-8")
        output_files.append(str(out_path))

    return make_html_links(output_files), f"âœ… {len(output_files)} ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸ"

with gr.Blocks() as app:
    gr.Markdown("## ğŸ“ æ ¡æ­£ãƒ„ãƒ¼ãƒ« Web UI")

    with gr.Row():
        start_button = gr.Button("â–¶ START")
        stop_button = gr.Button("â¸ STOP")
        resume_button = gr.Button("âµ å†é–‹")

    with gr.Row():
        global_hotwords = gr.Textbox(label="ğŸŒ Global Hotwords (1è¡Œ1èª)", lines=30, interactive=True, scale=1)
        local_hotwords = gr.Textbox(label="ğŸ“„ Local Hotwords (1è¡Œ1èª)", lines=30, interactive=True, scale=1)

        with gr.Column(scale=2):
            gr.Markdown("### ğŸ“‚ INPUT ãƒ•ã‚¡ã‚¤ãƒ«")
            input_files = gr.File(label="", file_types=[".txt"], file_count="multiple")

        with gr.Column(scale=2):
            gr.Markdown("### ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ« ãƒªãƒ³ã‚¯")
            output_links = gr.HTML(label="ğŸ”— å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒªãƒ³ã‚¯")

    result_text = gr.Textbox(label="ãƒ­ã‚°", lines=10, interactive=False)

    start_button.click(
        fn=run_proofreader,
        inputs=[global_hotwords, local_hotwords, input_files],
        outputs=[output_links, result_text]
    )

app.launch()
