# BlindX

<p align="center">
    <img src="./screenshots/title0.jpg" width="640">
</p>

BlindX は Transformer T5 (Text-to-Text Transfer Transformer) をベースにした推論機能を用いたな日本語処理
フロントエンドです。AI機能のもつ柔軟な日本語生成機能をもちながら、人間との最初のインターフェースとして素早く快適な応答を実現します。推論は GPU を使用した専用のサーバを介して行われます。
その結果を用いて日本語入力に対して障壁の低いエッジクライアントを構築できることを目指します。

ここでは大きな処理の流れを説明します。コードの詳細はリポジトリをご参照ください。

# サーバとの通信

BlindX サーバの自体は単純な websocket による非同期 echo サーバです。
基本的な通信ではクライアントがひらがな文を送信すると対応するかな漢字文が返信されます。


```python
import asyncio
while self.websocket:
    try:            
        if text:
            await self.websocket.send(dict_type + text)
            return await self.websocket.recv()
        else:
            return ''
    except websockets.ConnectionClosed:
        await self.websocket.close()
        self.websocket = await websockets.connect(self.uri)
```

サーバでの変換はスレッドごとにひとつの send() に対して対応するひとつの recv() で完結し、ステートレスで行われます。
すなわちサーバ側はクライアントの過去の状態は保持しません。

変換に際して、辞書の指定や前後の文脈などのコンテクストは、その都度再送信されます。

# 辞書の選択

変換にあたっては異なるコーパス（語彙のデータベース）から学習させた複数の辞書から適切なものが選択されます。

辞書の一例として以下のものがあります。

| 辞書名 | 下敷きとしたコーパス |
|-------|----------------|
| aozora256 | 青空文庫コーパス |
| wiki256 |  wikipedia コーパス |
| 2ch256 |  おーぷん２ちゃんねる対話コーパス |
| cc256 |  CC-100 コーパス |

これらの辞書は個人ごとではなく、それぞれの対象領域の語彙集合が時代とともに推移していくの合わせに更新されます。

辞書の選択は多くの場合アプリケーションの特性に応じて選ばれ、最終ユーザが意識することはありません。

# 変換の実際

## プリプロセッサ

Blindx は本体は、字句解析前の日本語ひらがなを入力とします。

しかしユーザから見ると、ひらがな入力自体は直接のインターフェースでありません。
デスクトップではキーボードによるローマ字入力、モバイルではフリック入力、あるいは音声・ジェスチャによる入力、
などファーストコンタクトの手段は、モーダル（使用形態）によって異なります。
そこで、BlindX ではモーダルごとに別個にプリプロセッサが置かれます。

<pre>

+-------------+  +------------------+
| Flick Input +--+ Error correction + ------------------------+
+-------------+  +------------------+                         |
                                                              |
+-------------+  +------------------+ +--------------------+  |
| keyboard    +--+ Error correction +-+ romaji-to-hiragana +--+-- Hiragana - BlindX
+-------------+  +------------------+ +--------------------+  | 
                                                              |
+-------------+  +-----------------+ +------------------+     |
| Audio input +--+ speech-to-text  +-* error correction +-----+
+-------------+  +-----------------+ +------------------+

</pre>

デスクトップアプリではキーボードのローマ字入力をひらがな文字に一旦変換する部分がこれにあたります。

> blindX のローマ字変換
> blindX のデフォルトのローマ字ひらがなパーサはいくつか拡張がされています。
> いくつかは既存の IME との相互運用を容易にするためのものです。
> - 半角英数字も一旦全角英数字に変換されます
>   - **2025ねん1がつ１にち** → **２０２５ねん１がつ１にち**
> - はじめからかな漢字のものはひらがなのまま出力されます
>   - **ashitanotenkiは晴れdatoomou** -> **あしたのてんきは晴れだとおもう**
> - バッククォートされた範囲は半角ローマ字のまま出力されます。
>   - **\`Hey Jude\` habi-toruzunogakkyokudesu** -> **Hey Jude はびーとるずのがっきょくです**

加えて、必要に応じてその前後にそのモーダル特有でおこりがちな誤入力を修正するフィルタが挿入されます。

## ライブ変換

変換は最短で１文字入力されるたびに即座に要求が発行されます。
この間隔は調整できます。

実際に変換が行われるかどうかは、ユーザのキーボードの入力速度およびその時点でのサーバのレイテンシによって判断されます。
例えば、キーボードの入力が十分遅いとき、「あしたのてんきははれだとおもう」の入力は、

| 入力   | 変換 |
|--------|-----|
|あ | あ |
|あし | 足 |
|あした | 明日 |
|あしたの | あしたの |
|あしたのて | 明日のて |
| | |
|あしたのてんきははれだとおもう | 明日の天気は晴れだと思う |

実際は、サーバへの変換要求の送信は一つ前の変換の返答が完了するまでペンディングされます。
それまでは入力されたひらがなが、最後に変換されたかな漢字文の末尾にそのまま追加されます。
そして、次の変換が確定した時点で、文字列は最新のかな漢字に変更されます。

この段階では変換は応答性を優先して、狭いウィンドウでの変換が行われます。より正確な変換は長いウィンドウで再度実行されます。
つまり変換は文脈のウィンドウをかえて複数回実行されることになります。

## 文章の訂正と校正

一旦確定した文章の修正には打ち間違いによる誤変換などの小規模なものと、より広い文脈を見た上でのものがあり、ここでは
前者を訂正、後者を校正と呼びます。

### 訂正

軽微な訂正は BlindX ができるだけ自動的に訂正することを試みます。
この場合はユーザは訂正があったこと自体を意識しません。

それでも失敗した修正は、通常の日本語変換と同じく、特定の部分のの候補を選択し、再推定します。
つまり推論器は対応する形態素の推定結果を、与えらた語句に固定し、再度推論を試みます。
このため、場合によっては一箇所を修正するとその周辺も適切に自動的に変更されます。

### 校正

より広い校正は、すでに一旦かな漢字が確定した以前の内容まで遡って再度翻訳単位に含めることで行われます。
推論器は前後の文章を反映して入力精度を向上を図ります。
これは会話文の羅列のような短い断片的な文が続くケースでは有効に作用します。

校正処理は入力の明確な区切りである句点や改行の時点で実行されます。
以下に例を示します。（ただし、説明のため極端に短い間隔で改行しています）

| 入力行 | 変換に参照されるウィンドウ | 
|------------|------------------------|
|しかもあとできくと | しかもあとできくと |
|しょせいという | しかもあとできくと + しょせいという |
|よのなかでもっとも | しかもあとできくと + しょせいという + よのなかでもっとも |
|どうあくないきものだそうだ | しかもあとできくと + しょせいという + よのなかでもっとも + どうあくないきものだそうだ |

実際の日本語変換は、この間に低レイテンシの短いウィンドウでの変換が間に挟まれます。
したがって上記の例では最小で以下の順番で変換されます。

| 入力 | その時点で確定した文 |
|------------|---------|
| しかもあとできくと | しかも後で聞くと |
| しょせいという | 処世という |
| しかもあとできくとしょせいという | 書生という |
| よのなかでもっとも| 世の中で最も |
| しかもあとできくとしょせいというよのなかでもっとも | 世の中で最も |
| どうあくないきものだそうだ | どうあくな生き物だそうだ |
| しかもあとできくとしょせいというよのなかでもっともどうあくないきものだそうだ | 獰悪ないきものだそうだ |

最後の変換結果は遡ってそれ以前の結果にも反映されることもあります。
ただし、実際は参照するウィンドウ自体も入力が進むにあわせてスライドします。
そのため、どの段の候補が採用されるかはその位置によって異なります。

### 広範囲な校正（オプション）

グループウェアやチャットのように複数の書き手がひとつの流れの文章を共同で構成していくケースでは
全員分のコンテキストを保持しておいて、広範な範囲で blindx のサーバで変換・編集をかけることが可能です。
各メッセージを時系列でマージして長いチャンクとして変換をかけることでより文脈に即した変換が期待できます。

# ショーケースとベストプラクティス

ここで上げた機能を実装した MIT ライセンスによるショーケースのコードが github にありますのでご参照ください。
ここでのコードにはいくつかの制限事項があります。

## BlindX の使用形態

BlindX の想定されるユースケースには 
-  BlindX FEP (Front End Processor) 経由するもの
- スタンドアロンアプリ
- web アプリ

が考えられますが、ショーケースではサーバサイドアプリケーションを前提としています。
スダンドアローンアプリとして実行する場合は若干の変更が必要になります。詳細はレポジトリを参照ください
※BlindX FEP については将来別途リリース予定です。

### FEP を経由する場合
通常の IME と同じになります。ユーザの入力コンテクストやログはローカルの FEP の中のみで閉じて蓄積され最終的に変換された
日本語だけがアプリケーションに渡されます。あるいは BlinX の通信のみを使って独自の FEP をサービスごとに実行する方法も
あります。

### Web App
Web アプリでは動的な UI で WSGI/ASGI など非同期な Web サーバが一般的に使われます。
この場合は、BlindX は実際には Web サーバと BlidX サーバの間で行なうことが考えられます。

### スタンドアロンアプリ
スタンドアロンのアプリの場合、BlindX サーバとの通信は認証が完了したのちクライアントとの直接通信になります。
また異なるクライアントからの入力を文脈に含めるため、共有機構が別途必要なります。

## 入力の反映方法

ユーザの入力の反映には
- 一旦フレームワークで用意されたテキストボックスういジェットにエコーされた文字列をフックして内容を動的に書き換える方法と、
- 低レベルのキーボード入力やマイク入力を捕獲する方法

があります。ショーケースでは２つの方法のいずれかが実装されています。

## スレッドと asyncio

blindx websocket 通信を  UI のバックグラウンドで行うのには asyncio とスレッドのいずれを使うこともできます。
可能な環境であれば asyncio ではなくスレッドを使うほうがサーバのコストを少なく素早い反応が期待できます。
変換処理自体は非常に軽量なためマシンあたり多くのリクエストを管理できます。そこで入力頻度が低い場合などで
入力が中断しているセッションは一旦接続を解除し、より多くの同時接続を試みることができます。この場合には
UI と同じイベントループで send()/recv() を行うよりは別スレッドのほうが有利となります。

## ショーケースで使用している UI フレームワーク

ショーケースの UIフレームワークでは flet を使用しています。

[Flet](https://flet.dev/)

BlindX に関わる部分は分離されています。

## Compare

実際の日本語変換機能の基本テストを行います。
参考までに mozcpy を用いた変換結果も同時に表示します。

[mozcpy](https://github.com/ikegami-yukino/mozcpy)

<p align="center">
   <video src="./screenshots/scompare2.mp4" controls="true" width="640"></video>
</p>

詳細とソースコードは github を参照ください

## Real-time Chat

非同期なリアルタイムチャット

共有された広い範囲の文脈を使ったメッセージングアプリの例です。
日本語変換のリアルタイム性とあいまって、より音声会話に近い感覚でテキスト会話が可能になります。

<p align="center">
   <video src="./screenshots/schat2.mp4" controls="true" width="480"></video>
</p>

詳細とソースコードは github を参照ください

## On-line Edit

パラグラフにまたがった広範囲の日本語変換をおこなったテキストエディタです。
またより低レベルのキーボード入力をハンドルしている例にもなっています。
最初のキーバインドは linux でのデフォルトの readline/emacs のキーバインドに沿っています。

<p align="center">
   <video src="./screenshots/report4.mp4" controls="true" width="640"></video>
</p>

詳細とソースコードは github を参照ください

## この記事について

“BlindX” is a registerd trademark of AXTech.Care Inc.
Our latest technology related to BlindX is currently patent-pending, and we are strengthening the protection of our intellectual property.

「BlindX」は AXTech.Care Inc. の登録商標です。
当社の BlindX に関連する最新技術は現在特許出願中であり、当社は知的財産の保護に努めてまいります。



